# CLAUDE.md

Этот файл предоставляет руководство для Claude Code (claude.ai/code) при работе с кодом в этом репозитории.

## Структура проекта

Highlight ERP - это двухкомпонентная система:

### Backend (highlight-erp/)
- **Фреймворк**: Laravel 12 с PHP 8.2+
- **API**: RESTful API с аутентификацией через Laravel Sanctum
- **База данных**: Миграции для управления схемой БД
- **Архитектура**: Repository pattern, отдельные контроллеры для Admin и Employee
- **Документация API**: Swagger (L5-Swagger)

### Frontend (highlight-erp_front/)
- **Фреймворк**: React 19 с TypeScript
- **Сборка**: Vite
- **Стилизация**: Tailwind CSS v4
- **Управление состоянием**: Zustand
- **Маршрутизация**: React Router DOM v7

## Команды разработки

### Backend (highlight-erp/)
```bash
# Запуск полной среды разработки (сервер + очереди + логи + Vite)
composer run dev

# Сборка фронтенд-ресурсов
npm run build

# Разработка с hot-reload
npm run dev

# Тестирование
composer run test
# или
php artisan test

# Очистка конфигурации
php artisan config:clear

# Запуск отдельных сервисов
php artisan serve
php artisan queue:listen --tries=1
php artisan pail --timeout=0

# Миграции
php artisan migrate

# Линтинг (Laravel Pint)
./vendor/bin/pint
```

### Frontend (highlight-erp_front/)
```bash
# Разработка
npm run dev

# Сборка для продакшена
npm run build

# Линтинг
npm run lint

# Предварительный просмотр сборки
npm run preview

# Проверка типов TypeScript
npx tsc --noEmit
```

## Архитектура системы

### Backend структура
- **app/Http/Controllers/Api/**: API контроллеры разделены по ролям (Admin/, Employee/)
- **app/Models/**: Eloquent модели (User, Document, DocumentUser, Position, Role)
- **app/Repositories/**: Repository pattern для работы с данными
- **routes/api.php**: API маршруты с комментариями на русском языке
- **database/migrations/**: Миграции для управления схемой БД

### Frontend структура
- **src/pages/**: React страницы
  - **LoginPage**: Страница входа в систему
  - **AdminDocumentsPage**: Страница списка документов администратора (карточный дизайн)
- **src/components/**: Переиспользуемые компоненты
  - **ProtectedRoute**: Компонент для защиты маршрутов
- **src/services/**: API клиенты и внешние сервисы
  - **auth.ts**: Сервис аутентификации
  - **adminDocuments.ts**: Сервис для работы с документами администратора
- **src/store/**: Zustand стейт менеджмент
- **src/hooks/**: Кастомные React хуки
- **src/types/**: TypeScript типы
  - **document.ts**: Типы для документов
- **src/utils/**: Утилитарные функции
  - **validators.ts**: Функции валидации для форм (имя, телефон, пароль, файлы)
  - **phoneUtils.ts**: Утилиты для маски и форматирования телефона

### API Endpoints
- Публичные маршруты: аутентификация
- Защищенные маршруты требуют Bearer Token (Laravel Sanctum)
- Разделение по ролям: Admin и Employee контроллеры

## Конфигурация разработки

### Backend
- **Тестирование**: PHPUnit с Laravel testing utilities
- **Линтинг**: Laravel Pint
- **Логирование**: Laravel Pail для real-time логов
- **Очереди**: Laravel queues для фоновых задач

### Frontend
- **ESLint**: Настроен с React и TypeScript правилами
- **Prettier**: Для форматирования кода
- **TypeScript**: Строгая конфигурация с несколькими tsconfig файлами
- **PostCSS**: С Tailwind CSS и Autoprefixer

## Особенности проекта

1. **Многоязычность**: Комментарии в API роутах на русском языке
2. **Роли пользователей**: Четкое разделение между Admin и Employee функциональностью
3. **Документооборот**: Основная функциональность связана с документами и пользователями
4. **Современный стек**: Использует последние версии Laravel и React
5. **Полная интеграция**: Composer скрипт `dev` запускает все необходимые сервисы одновременно

## Окружение

- **PHP**: 8.2+
- **Node.js**: Требуется для сборки фронтенда
- **Composer**: Для управления PHP зависимостями
- **NPM**: Для управления JavaScript зависимостями

При работе с проектом всегда проверяйте оба компонента (backend и frontend), так как они тесно интегрированы.

## Текущий прогресс разработки

### Реализовано

#### Backend
1. **Исправления и дополнения**
   - Добавлено поле `description` в валидацию `StoreDocumentRequest`
   - Добавлено сохранение `description` в `EloquentDocumentRepository::create()`
   - Поддержка обновления документов сотрудника через поле `documents` в `UpdateUserRequest`

2. **Валидация и локализация**
   - Добавлена валидация формата телефона: `regex:/^7\d{10}$/` (11 цифр, начинается с 7)
   - Кастомные сообщения об ошибках на русском языке в Request классах
   - Полная русификация валидации в `lang/ru/validation.php`
   - Установлен русский язык по умолчанию (`config/app.php`)
   - Ограничение описания документа: макс 5000 символов

#### Frontend

##### Компоненты

**UI компоненты:**
1. **UserHeader** - универсальный хедер с информацией о пользователе
   - Отображение аватара, ФИО (формат "Фамилия И. О."), роли
   - Использует `localStorage.getItem('user_data')`

2. **PageHeader** - заголовок страницы с кнопкой действия
   - Props: `title`, `buttonText`, `onButtonClick`

3. **DocumentCard** - переиспользуемая карточка документа
   - Кнопка скачивания, заголовок, описание
   - Кнопки редактирования и удаления

4. **EmployeeStatCard** - карточка статистики сотрудника
   - Раскрывающийся список документов
   - Зеленые галочки для прочитанных, красные крестики для непрочитанных

5. **AdminBottomNav** - нижняя навигация для администратора
   - Три раздела: сотрудники, документы, статистика
   - Активное состояние с зеленой подсветкой

6. **ProtectedRoute** - защита маршрутов с проверкой роли

**Компоненты форм (с валидацией):**
1. **FormInput** - текстовый инпут с label, валидацией и отображением ошибок
   - Индикация обязательных полей (*)
   - Красная подсветка при ошибке
   - Сообщение об ошибке под полем

2. **FormTextarea** - textarea с label, валидацией и отображением ошибок
   - Аналогичен FormInput, но для многострочного текста

3. **FormSelect** - select с label, валидацией и отображением ошибок
   - Стилизованный выпадающий список
   - Поддержка placeholder

4. **PhoneInput** - инпут телефона с автоматической маской
   - Формат: +7 (XXX) XXX-XX-XX
   - Автоформатирование при вводе
   - Валидация формата телефона

5. **PasswordInput** - инпут пароля с переключателем видимости
   - Кнопка показать/скрыть пароль
   - Валидация минимальной длины (8 символов)

6. **FileInput** - загрузка файлов с валидацией
   - Предпросмотр выбранного файла
   - Отображение размера файла
   - Кнопка удаления файла
   - Валидация типа и размера файла

##### Страницы администратора

1. **LoginPage** (`/login`)
   - Аутентификация по телефону и паролю
   - Сохранение токена и данных пользователя в localStorage

2. **AdminDocumentsPage** (`/admin/documents`)
   - Список документов в карточном дизайне
   - UserHeader + PageHeader
   - DocumentCard для каждого документа
   - Функции: просмотр, скачивание, редактирование, удаление
   - Модальное окно подтверждения удаления документа
   - AdminBottomNav

3. **CreateDocumentPage** (`/admin/documents/create`)
   - Форма создания документа с валидацией
   - Поля: название (обязательное, макс 255), описание (опциональное, макс 5000), файл (PDF/DOCX/XLSX, макс 10MB)
   - Чекбокс "Использовать для всех" (is_for_all_employees)
   - Валидация в реальном времени
   - Отображение ошибок под полями
   - Disabled кнопка при ошибках
   - Отправка через FormData

4. **AdminEmployeesPage** (`/admin/employees`)
   - Список сотрудников с карточками
   - Отображение ФИО в формате "Фамилия И. О."
   - Аватар или плейсхолдер с инициалами
   - Клик на карточку → переход на страницу сотрудника

5. **CreateEmployeePage** (`/admin/employees/create`)
   - Двухшаговая форма создания сотрудника с валидацией
   - Шаг 1: Личные данные (ФИО, должность, телефон, пароль)
     - Маска телефона +7 (XXX) XXX-XX-XX
     - Валидация ФИО (только буквы, макс 255)
     - Валидация телефона (11 цифр, начинается с 7)
     - Валидация пароля (мин 8 символов)
   - Шаг 2: Выбор документов (чекбоксы)
   - Disabled кнопка "Далее" при ошибках на шаге 1
   - Очистка телефона от нецифровых символов перед отправкой

6. **EmployeeDetailPage** (`/admin/employees/:id`)
   - Две вкладки: "Личные данные" и "Документы"
   - **Вкладка "Личные данные"**:
     - Редактируемые поля: Фамилия, Имя, Отчество, Должность, Телефон, Пароль
     - Маска телефона +7 (XXX) XXX-XX-XX (форматируется при загрузке)
     - Валидация всех полей в реальном времени
     - Пароль опционален (если пустой, не меняется)
   - **Вкладка "Документы"**:
     - Список всех документов с чекбоксами
     - Зеленая галочка для назначенных документов
   - Кнопки "Удалить" и "Сохранить" на обеих вкладках
   - Модальное окно подтверждения удаления сотрудника
   - Disabled кнопка "Сохранить" при ошибках валидации
   - При сохранении отправляются личные данные + массив ID документов
   - При ошибках валидации автоматически переключается на вкладку "Личные данные"
   - После сохранения → переход на `/admin/employees`

7. **AdminEmployeeStatsPage** (`/admin/statistics`)
   - Список сотрудников с раскрывающимися карточками
   - Статистика прочитанных/непрочитанных документов
   - EmployeeStatCard с иконками статуса

##### Сервисы
- `auth.ts` - аутентификация, хранение токена в localStorage
- `adminDocuments.ts` - CRUD операции с документами, скачивание
- `adminEmployees.ts` - CRUD операции с сотрудниками (поддержка поля `documents`)
- `adminPositions.ts` - получение списка должностей
- `adminStatistics.ts` - статистика по сотрудникам

##### Типы TypeScript
- `document.ts` - интерфейсы Document, AdminDocumentsResponse, AdminDocumentResponse
- `employee.ts` - интерфейс Employee с полями position, role, documents
- `statistics.ts` - интерфейсы EmployeeStatistics, Position, DocumentStatus

##### Маршруты
```
/login - Вход в систему
/admin/documents - Список документов
/admin/documents/create - Создание документа
/admin/employees - Список сотрудников
/admin/employees/create - Создание сотрудника
/admin/employees/:id - Просмотр/редактирование сотрудника
/admin/statistics - Статистика по сотрудникам
```

##### Тестовые учетные данные
- **Администратор**: телефон `79990001122`, пароль `password`
- **Сотрудник**: телефон `79991112233`, пароль `password` (Петров Петр Петрович, Бармен)

### В разработке / Планируется
- Страница редактирования документа (`/admin/documents/:id/edit`)
- Страница просмотра документа (`/admin/documents/:id`)
- Функционал для сотрудников (Employee):
  - Просмотр назначенных документов
  - Отметка документов как прочитанных
  - Профиль сотрудника
- Управление должностями и ролями через UI
- Поиск и фильтрация в списках
- Пагинация для больших списков
- Уведомления о новых документах

### Важные особенности реализации

1. **Формат ФИО**: Везде используется формат "Фамилия И. О." через функцию `getInitials()`
2. **Маска телефона**: Автоматическое форматирование в формат `+7 (XXX) XXX-XX-XX` через `phoneUtils.ts`
3. **Очистка телефона**: Перед отправкой на сервер телефон очищается от нецифровых символов через `cleanPhoneNumber()`
4. **Валидация форм**:
   - Frontend: в реальном времени через `validators.ts`
   - Backend: regex `/^7\d{10}$/` для телефона, кастомные сообщения на русском
5. **Хранение пользователя**: Данные пользователя хранятся в `localStorage` под ключом `user_data`
6. **FormData**: Для загрузки файлов используется FormData с полями: `title`, `description`, `file`, `is_for_all_employees`
7. **Синхронизация документов**: При обновлении сотрудника отправляется полный массив ID документов (sync, не attach/detach)
8. **Защита от открепления**: Бэкенд запрещает открепление документов со статусом "read"
9. **Индикация обязательных полей**: Красная звездочка `*` рядом с label обязательного поля
10. **Disabled состояние кнопок**: Кнопки "Создать"/"Сохранить" disabled при ошибках валидации или пустых обязательных полях
- Нужно грамотно подготовиться к деплою для этого ознакомься с инструкцией @"Деплой нового приложения на сервере с k3s _ Инструкция.pdf" и составь план доработак деплоя и план действий который сохрани во врменном файле
- Давай выполнять деплой согласно плану @DEPLOYMENT_README.md